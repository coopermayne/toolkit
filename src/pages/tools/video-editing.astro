---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Video Editing Suite - Legal Tools Suite" description="Trim, cut, and edit video files for depositions and evidence">
  <div class="max-w-7xl mx-auto">
    <!-- Back Button -->
    <a href="/" class="inline-flex items-center text-sm font-medium text-primary-600 hover:text-primary-700 mb-6">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Home
    </a>

    <!-- Tool Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="w-16 h-16 bg-primary-100 rounded-lg flex items-center justify-center">
            <svg class="w-8 h-8 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
          </div>
          <div>
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Video Editing Suite</h1>
            <p class="text-gray-600 mt-1">Trim, cut, and edit video files for depositions and evidence</p>
          </div>
        </div>
        <button id="resetBtn" class="hidden px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          Reset & Upload New Video
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Side: Video Area (2/3 width) -->
      <div class="lg:col-span-2">
        <!-- Drop Zone (shown initially) -->
        <div id="dropZone" class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-primary-400 transition-colors cursor-pointer">
          <input type="file" id="videoInput" accept="video/*" class="hidden" />
          <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          <h3 class="text-xl font-semibold text-gray-900 mb-2">Drop your video here</h3>
          <p class="text-gray-600 mb-4">or click to browse</p>
          <p class="text-sm text-gray-500">Supports MP4, MOV, AVI, and other common video formats</p>
        </div>

        <!-- Video Player (hidden initially) -->
        <div id="videoPlayerContainer" class="hidden bg-white border border-gray-200 rounded-lg overflow-hidden">
          <div class="relative bg-black">
            <video id="videoPlayer" class="w-full" controls>
              Your browser does not support the video tag.
            </video>
          </div>
          <div class="p-4 border-t border-gray-200">
            <div class="flex items-center justify-between text-sm">
              <div>
                <span class="font-medium text-gray-700">File:</span>
                <span id="videoFileName" class="text-gray-600 ml-2"></span>
              </div>
              <div>
                <span class="font-medium text-gray-700">Duration:</span>
                <span id="videoDuration" class="text-gray-600 ml-2">--:--</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Side: Tool Panels (1/3 width) -->
      <div class="lg:col-span-1">
        <!-- Universal Clip Selection Panel -->
        <div id="clipControlPanel" class="hidden bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
          <div class="bg-gradient-to-r from-primary-50 to-primary-100 px-4 py-3 border-b border-primary-200">
            <h3 class="text-sm font-semibold text-primary-900">Clip Selection</h3>
            <p class="text-xs text-primary-700 mt-0.5">Select the portion of video to work with</p>
          </div>
          <div class="p-4">
            <div class="space-y-4">
              <!-- Time Range Display -->
              <div class="flex items-center justify-between text-xs">
                <div>
                  <span class="font-medium text-gray-600">Start:</span>
                  <span id="startTimeDisplay" class="font-mono text-primary-700 ml-1">00:00</span>
                </div>
                <div>
                  <span class="font-medium text-gray-600">Duration:</span>
                  <span id="clipDuration" class="font-mono text-primary-700 ml-1">--:--</span>
                </div>
                <div>
                  <span class="font-medium text-gray-600">End:</span>
                  <span id="endTimeDisplay" class="font-mono text-primary-700 ml-1">00:00</span>
                </div>
              </div>

              <!-- Dual Range Slider -->
              <div class="relative h-12 pt-2">
                <div class="relative h-2 bg-gray-200 rounded-full">
                  <!-- Selected range highlight -->
                  <div id="rangeHighlight" class="absolute h-full bg-primary-400 rounded-full" style="left: 0%; width: 100%;"></div>
                </div>
                <!-- Start handle slider -->
                <input type="range" id="startTimeSlider" min="0" max="100" value="0" class="absolute top-0 w-full h-8 appearance-none bg-transparent pointer-events-none range-slider" style="z-index: 3;" />
                <!-- End handle slider -->
                <input type="range" id="endTimeSlider" min="0" max="100" value="100" class="absolute top-0 w-full h-8 appearance-none bg-transparent pointer-events-none range-slider" style="z-index: 4;" />
              </div>

              <button id="previewClipBtn" class="w-full px-3 py-2 text-sm bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors">
                Preview Clip
              </button>
            </div>
          </div>
        </div>

        <div id="toolPanels" class="hidden bg-white border border-gray-200 rounded-lg overflow-hidden">
          <!-- Tabs -->
          <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
              <button data-tab="pdf" class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-primary-600 border-b-2 border-primary-600">
                PDF Export
              </button>
              <button data-tab="zoom" class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-900 hover:border-gray-300">
                Zoom
              </button>
              <button data-tab="slowmo" class="tab-btn flex-1 px-4 py-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-900 hover:border-gray-300">
                Slow-Mo
              </button>
            </nav>
          </div>

          <!-- Tab Panels -->
          <div class="p-6">
            <!-- PDF Export Panel -->
            <div id="pdfPanel" class="tab-panel">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Export Video to PDF</h3>
              <p class="text-sm text-gray-600 mb-6">Export the selected clip as a PDF with video frames. Use the Clip Selection above to choose your range.</p>

              <!-- PDF Export Options -->
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Frame Options</label>
                <div class="space-y-3">
                  <label class="flex items-center">
                    <input type="checkbox" id="includeTimestamps" checked class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500" />
                    <span class="ml-2 text-sm text-gray-700">Include timestamps on frames</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" id="includeFrameNumbers" checked class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500" />
                    <span class="ml-2 text-sm text-gray-700">Include frame numbers</span>
                  </label>
                </div>
              </div>

              <div class="mb-6 pb-6 border-b border-gray-200">
                <label class="block text-sm font-medium text-gray-700 mb-3">Frame Rate</label>
                <select id="fpsSelect" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                  <option value="1">1 frame/sec (fewer frames)</option>
                  <option value="2">2 frames/sec</option>
                  <option value="5">5 frames/sec</option>
                  <option value="10" selected>10 frames/sec (recommended)</option>
                  <option value="30">30 frames/sec (all frames)</option>
                </select>
                <p class="text-xs text-gray-500 mt-2">Higher frame rates create larger PDF files</p>
              </div>

              <button class="w-full px-4 py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors">
                Export to PDF
              </button>
            </div>

            <!-- Zoom/Crop Panel -->
            <div id="zoomPanel" class="tab-panel hidden">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Zoom & Crop</h3>

              <div class="mb-6">
                <p class="text-sm text-gray-600 mb-4">Draw a box on the video preview to select the area to zoom into.</p>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                  <div class="aspect-video bg-gray-300 rounded flex items-center justify-center text-gray-500 text-sm">
                    Canvas for drawing zoom box (to be implemented)
                  </div>
                </div>

                <div class="space-y-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-2">Zoom Level</label>
                    <input type="range" id="zoomLevel" min="100" max="400" value="200" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" />
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                      <span>1x</span>
                      <span id="zoomLevelDisplay">2x</span>
                      <span>4x</span>
                    </div>
                  </div>

                  <button class="w-full px-3 py-2 text-sm bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                    Reset Selection
                  </button>
                </div>
              </div>

              <button class="w-full px-4 py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors">
                Apply Zoom
              </button>
            </div>

            <!-- Slow Motion Panel -->
            <div id="slowmoPanel" class="tab-panel hidden">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Slow Motion</h3>

              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Playback Speed</label>
                <div class="space-y-4">
                  <div>
                    <input type="range" id="speedSlider" min="10" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" />
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                      <span>0.1x (10%)</span>
                      <span>1x (100%)</span>
                    </div>
                  </div>
                  <div class="bg-primary-50 border border-primary-200 rounded p-4 text-center">
                    <p class="text-sm text-gray-600 mb-1">Current Speed</p>
                    <p class="text-2xl font-bold text-primary-900">
                      <span id="speedDisplay">0.5x</span>
                    </p>
                    <p class="text-xs text-gray-600 mt-1">
                      New duration: <span id="newDuration">--:--</span>
                    </p>
                  </div>
                </div>
              </div>

              <div class="mb-6 pb-6 border-b border-gray-200">
                <label class="block text-sm font-medium text-gray-700 mb-3">Apply to</label>
                <div class="space-y-2">
                  <label class="flex items-center">
                    <input type="radio" name="slowmoRange" value="full" checked class="w-4 h-4 text-primary-600 border-gray-300 focus:ring-primary-500" />
                    <span class="ml-2 text-sm text-gray-700">Entire video</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="slowmoRange" value="clip" class="w-4 h-4 text-primary-600 border-gray-300 focus:ring-primary-500" />
                    <span class="ml-2 text-sm text-gray-700">Selected clip only</span>
                  </label>
                </div>
              </div>

              <button class="w-full px-4 py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors">
                Create Slow Motion Video
              </button>
            </div>
          </div>
        </div>

        <!-- Placeholder when no video -->
        <div id="noVideoPlaceholder" class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
          <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
          </svg>
          <p class="text-sm text-gray-600">Upload a video to get started</p>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Regular sliders (for zoom, speed, etc.) */
    .slider::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #0ea5e9;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #0ea5e9;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .slider::-webkit-slider-thumb:hover {
      background: #0284c7;
    }

    .slider::-moz-range-thumb:hover {
      background: #0284c7;
    }

    /* Dual range slider styles */
    .range-slider {
      pointer-events: none;
    }

    .range-slider::-webkit-slider-thumb {
      appearance: none;
      pointer-events: all;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #0ea5e9;
      cursor: grab;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 10;
    }

    .range-slider::-moz-range-thumb {
      appearance: none;
      pointer-events: all;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #0ea5e9;
      cursor: grab;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 10;
    }

    .range-slider::-webkit-slider-thumb:hover {
      background: #0284c7;
      transform: scale(1.1);
    }

    .range-slider::-moz-range-thumb:hover {
      background: #0284c7;
      transform: scale(1.1);
    }

    .range-slider::-webkit-slider-thumb:active {
      cursor: grabbing;
      background: #075985;
    }

    .range-slider::-moz-range-thumb:active {
      cursor: grabbing;
      background: #075985;
    }

    /* Hide the slider track */
    .range-slider::-webkit-slider-runnable-track {
      appearance: none;
      background: transparent;
    }

    .range-slider::-moz-range-track {
      appearance: none;
      background: transparent;
    }
  </style>

  <script>
    // DOM Elements
    const dropZone = document.getElementById('dropZone');
    const videoInput = document.getElementById('videoInput');
    const videoPlayerContainer = document.getElementById('videoPlayerContainer');
    const videoPlayer = document.getElementById('videoPlayer');
    const videoFileName = document.getElementById('videoFileName');
    const videoDuration = document.getElementById('videoDuration');
    const toolPanels = document.getElementById('toolPanels');
    const clipControlPanel = document.getElementById('clipControlPanel');
    const noVideoPlaceholder = document.getElementById('noVideoPlaceholder');
    const resetBtn = document.getElementById('resetBtn');
    const previewClipBtn = document.getElementById('previewClipBtn');

    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');

    // Clip controls
    const startTimeSlider = document.getElementById('startTimeSlider');
    const endTimeSlider = document.getElementById('endTimeSlider');
    const startTimeDisplay = document.getElementById('startTimeDisplay');
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    const clipDuration = document.getElementById('clipDuration');
    const rangeHighlight = document.getElementById('rangeHighlight');

    // Zoom controls
    const zoomLevel = document.getElementById('zoomLevel');
    const zoomLevelDisplay = document.getElementById('zoomLevelDisplay');

    // Speed controls
    const speedSlider = document.getElementById('speedSlider');
    const speedDisplay = document.getElementById('speedDisplay');
    const newDuration = document.getElementById('newDuration');

    let videoFile = null;
    let videoDurationSeconds = 0;

    // Format seconds to MM:SS
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Drop zone click
    dropZone.addEventListener('click', () => {
      videoInput.click();
    });

    // Drag and drop handlers
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-primary-400', 'bg-primary-50');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('border-primary-400', 'bg-primary-50');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-primary-400', 'bg-primary-50');

      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type.startsWith('video/')) {
        handleVideoUpload(files[0]);
      }
    });

    // File input change
    videoInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleVideoUpload(e.target.files[0]);
      }
    });

    // Handle video upload
    function handleVideoUpload(file) {
      videoFile = file;
      const url = URL.createObjectURL(file);

      videoPlayer.src = url;
      videoFileName.textContent = file.name;

      // Show video player, hide drop zone
      dropZone.classList.add('hidden');
      videoPlayerContainer.classList.remove('hidden');
      clipControlPanel.classList.remove('hidden');
      toolPanels.classList.remove('hidden');
      noVideoPlaceholder.classList.add('hidden');
      resetBtn.classList.remove('hidden');

      // Load video metadata
      videoPlayer.addEventListener('loadedmetadata', () => {
        videoDurationSeconds = videoPlayer.duration;
        videoDuration.textContent = formatTime(videoDurationSeconds);

        // Set slider max values
        startTimeSlider.max = videoDurationSeconds;
        endTimeSlider.max = videoDurationSeconds;
        endTimeSlider.value = videoDurationSeconds;

        updateClipDisplay();
      });

      // Constrain playback to clip range
      videoPlayer.addEventListener('timeupdate', () => {
        const endTime = parseFloat(endTimeSlider.value);
        if (videoPlayer.currentTime > endTime) {
          videoPlayer.pause();
          videoPlayer.currentTime = parseFloat(startTimeSlider.value);
        }
      });
    }

    // Reset button
    resetBtn.addEventListener('click', () => {
      videoPlayer.src = '';
      videoFile = null;
      videoInput.value = '';

      dropZone.classList.remove('hidden');
      videoPlayerContainer.classList.add('hidden');
      clipControlPanel.classList.add('hidden');
      toolPanels.classList.add('hidden');
      noVideoPlaceholder.classList.remove('hidden');
      resetBtn.classList.add('hidden');
    });

    // Preview clip button
    previewClipBtn.addEventListener('click', () => {
      const startTime = parseFloat(startTimeSlider.value);
      videoPlayer.currentTime = startTime;
      videoPlayer.play();
    });

    // Tab switching
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;

        // Update tab buttons
        tabBtns.forEach(b => {
          b.classList.remove('text-primary-600', 'border-primary-600');
          b.classList.add('text-gray-600', 'border-transparent');
        });
        btn.classList.add('text-primary-600', 'border-primary-600');
        btn.classList.remove('text-gray-600', 'border-transparent');

        // Update panels
        tabPanels.forEach(panel => panel.classList.add('hidden'));
        document.getElementById(`${tabName}Panel`).classList.remove('hidden');
      });
    });

    // Clip selection sliders
    function updateClipDisplay() {
      const startTime = parseFloat(startTimeSlider.value);
      const endTime = parseFloat(endTimeSlider.value);

      // Ensure start is before end
      if (startTime >= endTime) {
        startTimeSlider.value = Math.max(0, endTime - 1);
      }

      const start = parseFloat(startTimeSlider.value);
      const end = parseFloat(endTimeSlider.value);

      startTimeDisplay.textContent = formatTime(start);
      endTimeDisplay.textContent = formatTime(end);
      clipDuration.textContent = formatTime(end - start);

      // Update visual range highlight
      if (videoDurationSeconds > 0) {
        const startPercent = (start / videoDurationSeconds) * 100;
        const endPercent = (end / videoDurationSeconds) * 100;
        rangeHighlight.style.left = `${startPercent}%`;
        rangeHighlight.style.width = `${endPercent - startPercent}%`;
      }

      // If video is playing outside clip range, move it to start
      if (videoPlayer.src && videoPlayer.currentTime > 0) {
        if (videoPlayer.currentTime < start || videoPlayer.currentTime > end) {
          videoPlayer.currentTime = start;
        }
      }
    }

    startTimeSlider.addEventListener('input', updateClipDisplay);
    endTimeSlider.addEventListener('input', updateClipDisplay);

    // Zoom level
    zoomLevel.addEventListener('input', () => {
      const zoom = parseFloat(zoomLevel.value) / 100;
      zoomLevelDisplay.textContent = `${zoom.toFixed(1)}x`;
    });

    // Speed slider
    speedSlider.addEventListener('input', () => {
      const speed = parseFloat(speedSlider.value) / 100;
      speedDisplay.textContent = `${speed.toFixed(2)}x`;

      if (videoDurationSeconds > 0) {
        const newDur = videoDurationSeconds / speed;
        newDuration.textContent = formatTime(newDur);
      }
    });
  </script>
</BaseLayout>
